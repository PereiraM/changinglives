<div class="hdr">
    <h3><span></span>Submit: What's in your pantry?</h3>
    <div class="close">X</div>
</div>

<div class="tumblr-form">
    <div style="font-family: CrossStitch;">.</div>
    <form id="tumblr-form" method="post" enctype="multipart/form-data" action="http://{{ SERVERS[0] }}/{{ PROJECT_SLUG }}/">
        <ol>
            <li class="form-intro">
                <!-- <h2>This project has now concluded. Thank you for your submissions.</h2> -->
                <p>This is some text for the form kicker.</p>
                </li>
            <li class="form-photo">
                <div id="preview" style="width: 640px; height: 480px;"></div>
                <input type="hidden" name="image">
                <label for="string">Enter your message:</label>
                <textarea name="string"></textarea>
            </li>
            <li class="form-message">
                <label for="message" class="instructions">
                        <strong>SHARE:</strong><br />Tell us about you.
                </label>
                <textarea name="message"></textarea>
            </li>
    {{ JS.push('js/lib/cufon-yui.js') }}
            <li class="form-signature">
            <label for="signed_name">Initialed,</label>
                <input type="text" name="signed_name" placeholder="Your Initials" class="signed-name"></input>
                from
                <input type="text" name="location" placeholder="Your City And State" class="signed-location"></input>
            </li>

            <li class="form-submit">
                <span class="gentle-reminder" style="display: none;">Please add a photo, an explanation, your initials and where you&rsquo;re from. Thanks!</span>
                <button type="submit" class="btn">Send</button>
            </li>
        </ol>
    </form>
    <!--[if IE]>
    <script type="text/javascript">
        /*
        * Handle simple form validation for browsers that do not support
        * the HTML5 "required" attribute on form elements.
        */
        $('#tumblr-form').submit(function(event){
           var $this = $(this);
           var inputs = [];
           inputs.push($this.find('textarea').text());
           inputs.push($this.find("input[type='file']").attr('value'));
           inputs.push($this.find("input[name='signed_name']").attr('value'));
           inputs.push($this.find("input[name='location']").attr('value'));
           _.each(inputs, function(input){
               if (input === '') {
                   event.preventDefault();
                   $this.find('span.gentle-reminder').show();
               }
           });
        });
    </script>
    <![endif]-->

    <script type="text/javascript">
        var BG_COLOR = '#787878';
        var DOT_COLOR = '#444';
        var FONT_NAME = 'Quicksand';
        var FONT_COLOR = '#fff';
        var FONT_SIZE = 120;
        var LINE_HEIGHT = 110;
        var X_DOTS = 64;

        $(document).ready(function() {
            var $preview = $('#preview');
            var preview_div = $preview[0];

            if (!Raphael.svg) {
                alert('Your browser doesn\'t support SVG, so this will be broken.');
            }

            var preview = new Raphael(preview_div, $preview.width(), $preview.height());
    
            var width = $preview.width();
            var height = $preview.height();

            var bg = preview.rect(0, 0, width, height);
            bg.attr({ fill: BG_COLOR, 'stroke-width': 0 });

            var y_dots = X_DOTS * (height / width)
            var x_pitch = width / X_DOTS;
            var y_pitch = height / y_dots;

            for (var x = 1; x < X_DOTS; x++) {
                for (var y = 1; y < y_dots; y++) {
                    preview.circle(x * x_pitch, y * y_pitch, 1).attr({ fill: DOT_COLOR, 'stroke-width': 0 });
                }
            }

            var font = preview.getFont(FONT_NAME);
            var text_paths = [];
            
            function render(text) {
                for (var i = 0; i < text_paths.length; i++) {
                    text_paths[i].remove();
                }

                text_paths = [];

                var lines = text.split('\n');
                var lines_height = LINE_HEIGHT * lines.length;
                var base_width = (width / 2);

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i];

                    var text_path = preview.print(0, 0, line, font, FONT_SIZE, 'middle');
                    
                    var bbox = text_path.getBBox();
                    text_path.translate(base_width - (bbox.width / 2), 0)
                    
                    text_paths.push(text_path);
                }

                var base_height = (height / 2) - (lines_height / 2)

                for (var i = 0; i < text_paths.length; i++) {
                    var text_path = text_paths[i];

                    text_path.translate(0, base_height + LINE_HEIGHT * i);
                    text_path.attr({ fill: FONT_COLOR }); 
                }
            }

            render('');

            $('textarea[name="string"]').keyup(function(e) {
                render($(this).val());    
            });

            $('#tumblr-form').submit(function(e) {
                var btn = $('.form-submit button');

                btn.text('Sending, please wait...');
                // btn.attr('disabled', 'disabled');

                $('input[name="image"]').val($preview.html());

                return true;
            });

            if (/iP(hone|od|ad)/.test(navigator.platform)) {
                var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
                var version = parseInt(v[1]);

                if (version < 6) {
                    $('.tumblr-form').html('<p>Sorry, iOS versions older than 6 are not supported.');
                }
            }
        });
    </script>
</div>
